{
  "version": 3,
  "sources": ["../../@evidence-dev/sdk/src/lib/sharedPromise.js"],
  "sourcesContent": ["/**\n * @template [ResolveType=unknown]\n * @typedef {Object} SharedPromise\n * @property {Promise<ResolveType>} promise\n * @property {(v: ResolveType) => unknown} resolve\n * @property {(e: Error) => unknown} reject\n * @property {'init' | 'loading' | 'resolved' | 'rejected'} state\n * @property {ResolveType | null} value\n * @property {() => void} start\n **/\n\n/**\n * @template [ResolveType=unknown]\n * @param {() => void} [stateChangeHook]\n * @returns {SharedPromise<ResolveType>}\n */\nexport const sharedPromise = (stateChangeHook) => {\n\t/** @type {((v: ResolveType) => unknown) | null} */\n\tlet res = null;\n\t/** @type {((e: Error) => unknown) | null} */\n\tlet rej = null;\n\t/** @type {Promise<ResolveType>} */\n\tconst p = new Promise((a, b) => {\n\t\tres = a;\n\t\trej = b;\n\t});\n\n\t/** @type {'init' | 'loading' | 'resolved' | 'rejected'} */\n\tlet state = 'init';\n\n\t/**\n\t * @type {ResolveType | null}\n\t */\n\tlet resolvedValue = null;\n\n\tif (!res || !rej) throw new Error();\n\treturn {\n\t\tpromise: p,\n\t\t/**\n\t\t * @param {ResolveType} v\n\t\t */\n\t\tresolve: (v) => {\n\t\t\tif (res) {\n\t\t\t\tif (state === 'loading' || state === 'init') {\n\t\t\t\t\tstate = 'resolved';\n\t\t\t\t\tresolvedValue = v;\n\t\t\t\t\tres(v);\n\t\t\t\t\tstateChangeHook?.();\n\t\t\t\t}\n\t\t\t} else throw new Error('SharedPromise encountered an error: res not defined');\n\t\t},\n\t\t/**\n\t\t *\n\t\t * @param {Error} e\n\t\t */\n\t\treject: (e) => {\n\t\t\tif (rej) {\n\t\t\t\tif (state === 'loading' || state === 'init') {\n\t\t\t\t\tstate = 'rejected';\n\t\t\t\t\tp.catch(() => {}); // noop to prevent the page from dying. This does not prevent .catch from working in other places\n\t\t\t\t\trej(e);\n\t\t\t\t\tstateChangeHook?.();\n\t\t\t\t}\n\t\t\t} else throw new Error('SharedPromise encountered an error: rej not defined');\n\t\t},\n\t\tget state() {\n\t\t\treturn state;\n\t\t},\n\t\tget value() {\n\t\t\treturn resolvedValue;\n\t\t},\n\t\tstart() {\n\t\t\tstate = 'loading';\n\t\t\tstateChangeHook?.();\n\t\t}\n\t};\n};\n"],
  "mappings": ";AAgBO,IAAM,gBAAgB,CAAC,oBAAoB;AAEjD,MAAI,MAAM;AAEV,MAAI,MAAM;AAEV,QAAM,IAAI,IAAI,QAAQ,CAAC,GAAG,MAAM;AAC/B,UAAM;AACN,UAAM;AAAA,EACP,CAAC;AAGD,MAAI,QAAQ;AAKZ,MAAI,gBAAgB;AAEpB,MAAI,CAAC,OAAO,CAAC;AAAK,UAAM,IAAI,MAAM;AAClC,SAAO;AAAA,IACN,SAAS;AAAA;AAAA;AAAA;AAAA,IAIT,SAAS,CAAC,MAAM;AACf,UAAI,KAAK;AACR,YAAI,UAAU,aAAa,UAAU,QAAQ;AAC5C,kBAAQ;AACR,0BAAgB;AAChB,cAAI,CAAC;AACL;AAAA,QACD;AAAA,MACD;AAAO,cAAM,IAAI,MAAM,qDAAqD;AAAA,IAC7E;AAAA;AAAA;AAAA;AAAA;AAAA,IAKA,QAAQ,CAAC,MAAM;AACd,UAAI,KAAK;AACR,YAAI,UAAU,aAAa,UAAU,QAAQ;AAC5C,kBAAQ;AACR,YAAE,MAAM,MAAM;AAAA,UAAC,CAAC;AAChB,cAAI,CAAC;AACL;AAAA,QACD;AAAA,MACD;AAAO,cAAM,IAAI,MAAM,qDAAqD;AAAA,IAC7E;AAAA,IACA,IAAI,QAAQ;AACX,aAAO;AAAA,IACR;AAAA,IACA,IAAI,QAAQ;AACX,aAAO;AAAA,IACR;AAAA,IACA,QAAQ;AACP,cAAQ;AACR;AAAA,IACD;AAAA,EACD;AACD;",
  "names": []
}
